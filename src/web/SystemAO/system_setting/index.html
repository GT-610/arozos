<!DOCTYPE html>
<html>

<head>
    <title>System Setting</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0 user-scalable=no">
    <link rel="preload" href="../../script/semantic/semantic.min.css" as="style" onload="this.rel='stylesheet'">
    <script src="../../script/jquery.min.js"></script>
    <script src="../../script/semantic/semantic.min.js"></script>
    <script src="../../script/ao_module.js"></script>
    <script src="../../script/applocale.js"></script>
    <style>
        html {
            overflow: hidden;
            height: 100%;
        }

        body {
            background-color: #fcfcfc;
            overflow: hidden !important;
            height: 100%;
        }

        #mainSideMenuDimmer {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0px;
            left: 0px;
            background-color: rgba(26, 26, 26, 0.3);
            z-index: 99;
        }

        #mainSideMenu {
            z-index: 100;
            transition: transform 0.3s ease;
        }

        #settingContentLoader {
            overflow-x: hidden;
            overflow-y: auto;
            height: calc(100% - 60px);
        }

        #mainFunctionTabMenu {
            background-color: #f8f8f8;
            margin-top: 0;
            padding-top: 1em;
            border-radius: 0 0 0 0 !important;
        }

        #msgbox {
            position: fixed;
            bottom: 0.2em;
            right: 2em;
            display: none;
        }
    </style>
</head>

<body>
    <div id="mainSideMenu" class="ui left fixed vertical menu">
        <div class="item">
            <img class="ui image" src="img/banner.png">
        </div>

    </div>
    <div id="mainSideMenuDimmer" onclick="hideToolBar();"></div>
    <div id="mainFunctionTabMenu" class="ui top attached tabular menu" style="overflow-x:auto;overflow-y:hidden;">
        <a id="toolbarBtn" class="item" onclick="showToolBar();">
            <i class="content icon"></i>
        </a>

        <div class="right menu">
            <!--
                <div class="item">
                    <div class="ui transparent icon input">
                    <input id="searchInput" type="text" placeholder="Search Settings..." onkeydown="if (event.which == 13){ search(); }">
                        <i class="search link icon" onclick="search();"></i>
                    </div>
                </div>
                -->
        </div>
    </div>
    <div id="settingContentLoader" class="ui bottom attached segment">

    </div>
    <div id="msgbox" class="ui compact small message">
        Hello World
    </div>
    </div>

    <script>
        var currentSettingModuleList = [];
        var loadViaSystemSetting = true; //Check for this parameter to see if launching in Setting Interface
        var loadToPage = undefined; //Load setting page directly to the given tab, passed in via window hash

        if (window.location.hash.length > 0) {
            var hashObject = window.location.hash.substr(1);
            hashObject = JSON.parse(decodeURIComponent(hashObject));
            if (typeof (hashObject.group) != 'undefined' && typeof (hashObject.name) != 'undefined') {
                loadToPage = hashObject;
            }
        }

        applocale.init("../locale/system_settings.json", function () {
            applocale.translate();
            //Initiation Functions
            initMainSideMenu();
            hideToolBar();

            if (loadToPage == undefined) {
                initSettingGroup("Info");
            } else {
                initSettingGroup(loadToPage.group, function (settingList) {
                    let reversedList = JSON.parse(JSON.stringify(settingList)).reverse();
                    for (var i = 0; i < settingList.length; i++) {
                        var settingTab = settingList[i];
                        if (settingTab.Name == loadToPage.name) {
                            //This is the tab we are looking for
                            initSettingModules(i - 1);
                        }
                    }

                });
            }
        });


        function initMainSideMenu() {
            $.get("../../system/setting/list", function (data) {
                let menuItems = [];
                for (let i = 0; i < data.length; i++) {
                    const item = data[i];
                    const settingGroupName = applocale.getString(
                        "menu/group/" + item.Name,
                        item.Name
                    );
                    menuItems.push(`
                <a class="item" group="${item.Group}" title="${item.Desc}" style="padding:4px;">
                    <img class="ui middle aligned mini image" src="../../${item.IconPath}" style="padding: 2px;">
                    ${settingGroupName}
                </a>
            `);
                }
                $("#mainSideMenu").append(menuItems.join(''));  // Single Append
                applocale.translate();
            });
        }

        function initSettingGroup(group, callback = undefined) {
            $.get("../../system/setting/list?listGroup=" + group, function (data) {
                if (data.error !== undefined) {
                    console.log(data.error);
                } else {
                    currentSettingModuleList = data;
                    initSettingModuleTabs(group);
                    initSettingModules(0);
                    if (callback != undefined) {
                        callback(data);
                    }
                }
            });
        }

        function menuClicked(object) {
            var group = $(object).attr("group");
            initSettingGroup(group);
            hideToolBar();
        }

        //Initiate the setting modules tabs
        function initSettingModuleTabs(groupName) {
            $(".settingTab").remove();
            const tabs = [];

            for (let i = 0; i < currentSettingModuleList.length; i++) {
                const thisModuleInfo = currentSettingModuleList[i];
                const stringifyModuleInfo = encodeURIComponent(JSON.stringify(thisModuleInfo));
                const localeGroupKey = "tab/" + groupName.toLowerCase() + "/" + thisModuleInfo.Name;
                const displayTabName = applocale.getString(localeGroupKey, thisModuleInfo.Name);

                tabs.push(`
            <a class="item settingTab" moduleInfo="${stringifyModuleInfo}" 
               title="${thisModuleInfo.Desc}" 
               data-group="${groupName}">
               ${displayTabName}
            </a>
        `);
            }

            $("#toolbarBtn").after(tabs.join(''));
            applocale.translate();
        }

        const $loader = $("#settingContentLoader"); // Cache selector

        function loadSettingModule(targetObject) {
            const $target = $(targetObject);
            $(".settingTab.active").removeClass("active");
            $target.addClass("active");

            const settingModuleInfo = JSON.parse(decodeURIComponent($target.attr("moduleInfo")));
            const settingStartDir = "../../" + settingModuleInfo.StartDir;

            $loader.html("").load(settingStartDir, function () {
                injectIMEToLoadedConetentFrame();
            });
        }

        function initSettingModules(index) {
            const targetObject = $(".settingTab").eq(index);
            if (targetObject.length) {
                loadSettingModule(targetObject);
            }
        }

        function loadSettingModuleFromTab(object) {
            loadSettingModule(object);
        }

        function injectIMEToLoadedConetentFrame() {
            const $loader = document.getElementById("settingContentLoader");
            const inputs = $loader.querySelectorAll("input,textarea");

            Array.prototype.forEach.call(inputs, (input) => {
                const type = $(input).attr("type") || "textarea";
                if (["text", "search", "url", "textarea"].includes(type) && ao_module_virtualDesktop) {
                    ao_module_bindCustomIMEEvents(input);
                }
            });

            // Release NodeList reference to avoid memory leak
            inputs.length = 0;
        }

        // Use transform instead of jQuery animate
        function hideToolBar() {
            $("#mainSideMenuDimmer").fadeOut('fast');
            $("#mainSideMenu").css('transform', 'translateX(-100%)');
        }

        function showToolBar() {
            $("#mainSideMenuDimmer").fadeIn('fast');
            $("#mainSideMenu").css('transform', 'translateX(0)');
        }

        function search() {
            var keyword = $("#searchInput").val();
            alert(keyword);
        }

        function msgbox(message, succ = true, delay = 3000) {
            $("#msgbox").html(`<i class="ui ${succ ? "green circle check" : "red circle times"} icon"></i> ${message}`);
            $("#msgbox").stop().finish().fadeIn("fast").delay(delay).fadeOut("fast");
        }

        $(document).ready(function () {
            // Sidebar handler
            $("#mainSideMenu").on('click', '.item[group]', function () {
                menuClicked(this);
            });
            // Tab handler
            $("#mainFunctionTabMenu").on('click', '.settingTab', function () {
                loadSettingModuleFromTab(this);
            });
        });

    </script>
</body>

</html>